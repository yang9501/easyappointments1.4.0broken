window.BackendCalendarTableView=window.BackendCalendarTableView||{},function(e){"use strict";var a,t,n;function r(e,a){$("#calendar .calendar-header .btn").addClass("disabled").prop("disabled",!0);var t={};$(".provider-column").each(function(e,a){var n=$(a),r=n.data("provider").id;t[r]=n.find(".calendar-wrapper").fullCalendar("getView").name}),$("#calendar .calendar-view").remove(),Backend.placeFooterToBottom();var n=$("<div/>",{class:"calendar-view"}).appendTo("#calendar");n.data({startDate:e.toString("yyyy-MM-dd"),endDate:a.toString("yyyy-MM-dd")});var r=$("<div/>").appendTo(n);x(e,a).done(function(n){for(var s=e;s<=a;)i(r,s,n),s.add({days:1});D(),Backend.placeFooterToBottom(),$("#calendar .calendar-header .btn").removeClass("disabled").prop("disabled",!1),$(".provider-column").each(function(e,a){var n=$(a),r=n.data("provider").id;n.find(".calendar-wrapper").fullCalendar("changeView",t[r]||"agendaDay")})})}function i(e,n,r){var i=$("<div/>",{class:"date-column"}).appendTo(e);i.data("date",n.getTime()),$("<h5/>",{class:"date-column-title",text:GeneralFunctions.formatDate(n,GlobalVariables.dateFormat)}).appendTo(i);var p=a.val(),u=t.val(),f=GlobalVariables.availableProviders.filter(function(e){var a=e.services.filter(function(e){return u.filter(function(a){return Number(e)===Number(a)}).length});return!p.length&&!u.length||a.length||-1!==p.indexOf(e.id)});"provider"===GlobalVariables.user.role_slug&&GlobalVariables.availableProviders.forEach(function(e){Number(e.id)===Number(GlobalVariables.user.id)&&(f=[e])}),"secretary"===GlobalVariables.user.role_slug&&(f=[],GlobalVariables.availableProviders.forEach(function(e){GlobalVariables.secretaryProviders.indexOf(e.id)>-1&&f.push(e)})),f.forEach(function(e){!function(e,a,t,n){if(0===t.services.length)return;var r=$("<div/>",{class:"provider-column"}).appendTo(e);r.data("provider",t),function(e,a,t){var n=$("<div/>",{class:"calendar-wrapper"}).appendTo(e),r="";switch(GlobalVariables.dateFormat){case"DMY":r="ddd D/M";break;case"MDY":case"YMD":r="ddd M/D";break;default:throw new Error("Invalid date format setting provided!",GlobalVariables.dateFormat)}var i="",l="";switch(GlobalVariables.timeFormat){case"military":i="H:mm",l="H(:mm)";break;case"regular":i="h:mm a",l="h(:mm) a";break;default:throw new Error("Invalid time format setting provided!"+GlobalVariables.timeFormat)}var c=GlobalVariables.firstWeekday,m=GeneralFunctions.getWeekDayId(c);n.fullCalendar({defaultView:"agendaDay",height:s(),editable:!0,timeFormat:i,slotLabelFormat:l,allDaySlot:!0,columnFormat:r,firstDay:m,snapDuration:"00:15:00",header:{left:"listDay,agendaDay",center:"",right:""},selectable:!0,selectHelper:!0,select:function(e,a,t){if(e.hasTime()&&a.hasTime()){$("#insert-appointment").trigger("click");var n=$(t.target).parents(".provider-column"),r=n.data("provider").id,i=GlobalVariables.availableProviders.find(function(e){return Number(e.id)===Number(r)}),s=GlobalVariables.availableServices.find(function(e){return-1!==i.services.indexOf(e.id)});return s&&$("#select-service").val(s.id),$("#select-service").val()||$("#select-service option:first").prop("selected",!0),$("#select-service").trigger("change"),i&&$("#select-provider").val(i.id),$("#select-provider").val()||$("#select-provider option:first").prop("selected",!0),$("#select-provider").trigger("change"),$("#start-datetime").datepicker("setDate",new Date(e.format("YYY/MM/DD HH:mm:ss"))),$("#end-datetime").datepicker("setDate",new Date(a.format("YYYY/MM/DD HH:mm:ss"))),!1}},monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],monthNamesShort:[EALang.january.substr(0,3),EALang.february.substr(0,3),EALang.march.substr(0,3),EALang.april.substr(0,3),EALang.may.substr(0,3),EALang.june.substr(0,3),EALang.july.substr(0,3),EALang.august.substr(0,3),EALang.september.substr(0,3),EALang.october.substr(0,3),EALang.november.substr(0,3),EALang.december.substr(0,3)],dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],buttonText:{today:EALang.today,day:EALang.day,week:EALang.week,month:EALang.month,agendaDay:EALang.calendar,listDay:EALang.list},eventClick:h,eventResize:_,eventDrop:E,dayClick:d,viewRender:o}),n.fullCalendar("gotoDate",moment(a)),$("<h6/>",{text:t.first_name+" "+t.last_name}).prependTo(e)}(r,a,t),l(r.find(".calendar-wrapper"),t),c(r,n.appointments),m(r,n.unavailability_events),Backend.placeFooterToBottom()}(i,n,e,r)})}function s(){var e=window.innerHeight-$("#footer").outerHeight()-$("#header").outerHeight()-60;return e>500?e:500}function d(e){$("#insert-appointment").trigger("click");var a=$("#manage-appointment"),t=$(this).closest(".provider-column").data("provider").id,n=GlobalVariables.availableProviders.find(function(e){return Number(e.id)===Number(t)});if(n){var r=GlobalVariables.availableServices.find(function(e){return-1!==n.services.indexOf(e.id)});n.services.length&&(a.find("#select-service").val([n.services[0]]).trigger("change"),a.find("#select-provider").val(n.id),a.find("#start-datetime").val(GeneralFunctions.formatDate(e,GlobalVariables.dateFormat,!0)),a.find("#start-datetime").datepicker("setDate",e),a.find("#end-datetime").val(GeneralFunctions.formatDate(e.addMinutes(r.duration),GlobalVariables.dateFormat,!0)),a.find("#end-datetime").datepicker("setDate",e))}}function o(e,a){$(a).fullCalendar("option","height",s())}function l(e,a){var t=JSON.parse(a.settings.working_plan),n=JSON.parse(a.settings.working_plan_exceptions)||{},r=e.fullCalendar("getView"),i=r.start.clone(),s=r.end.clone(),d=i.toDate().toString("dddd").toLowerCase(),o=i.format("YYYY-MM-DD");if(n[o]){t[d]=n[o];var l=o+" "+t[d].start,c=o+" "+t[d].end,m={title:EALang.working_plan_exception,start:moment(l,"YYYY-MM-DD HH:mm",!0),end:moment(c,"YYYY-MM-DD HH:mm",!0).add(1,"day"),allDay:!0,color:"#879DB4",editable:!1,className:"fc-working-plan-exception fc-custom",data:{date:o,workingPlanException:n[o],provider:a}};e.fullCalendar("renderEvent",m,!1)}if(null!==t[d]){var p=moment(i.toDate().toString("yyyy-MM-dd")+" "+t[d].start);i<p&&(v={title:EALang.not_working,start:i,end:p,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"},e.fullCalendar("renderEvent",v,!1));var u,f,b=moment(i.toDate().toString("yyyy-MM-dd")+" "+t[d].end);if(s>b){var v={title:EALang.not_working,start:b,end:s,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"};e.fullCalendar("renderEvent",v,!1)}t[d].breaks.forEach(function(a){u=moment(i.toDate().toString("yyyy-MM-dd")+" "+a.start),f=moment(i.toDate().toString("yyyy-MM-dd")+" "+a.end);var t={title:EALang.break,start:u,end:f,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable fc-break"};e.fullCalendar("renderEvent",t,!1)})}else{var g={title:EALang.not_working,start:i,end:s,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"};e.fullCalendar("renderEvent",g,!0)}}function c(e,a){if(0!==a.length){var n=t.val();a=a.filter(function(e){return!n.length||-1!==n.indexOf(e.id_services)});var r=[];for(var i in a){var s=a[i];s.id_users_provider===e.data("provider").id&&r.push({id:s.id,title:s.service.name+" - "+s.customer.first_name+" "+s.customer.last_name,start:moment(s.start_datetime),end:moment(s.end_datetime),allDay:!1,data:s})}e.find(".calendar-wrapper").fullCalendar("addEventSource",r)}}function m(e,a){if(0!==a.length)for(var t in a){var n=a[t];if(n.id_users_provider===e.data("provider").id){var r={title:EALang.unavailable,start:moment(n.start_datetime),end:moment(n.end_datetime),allDay:!1,color:"#879DB4",editable:!0,className:"fc-unavailable fc-custom",data:n};e.find(".calendar-wrapper").fullCalendar("renderEvent",r,!1)}}}function p(e,a){if(0!==a.length){var t=new Date(e.parents(".date-column").data("date")),n=e.find("table tbody");for(var r in a){var i=a[r],s=i.start.split(":"),d=new Date(t.getFullYear(),t.getMonth(),t.getDate(),s[0],s[1]),o=i.end.split(":"),l=new Date(t.getFullYear(),t.getMonth(),t.getDate(),o[0],o[1]),c=Math.round((l-d)/6e4),m=$("<div/>",{class:"event unavailability break"});m.html(EALang.break+' <span class="hour">'+d.toString("HH:mm")+"</span> ("+c+"')"),m.data(i),n.find("tr").each(function(e,a){var n=$(a).find("td:first"),r=new Date(t.getTime()).set({hour:parseInt(n.text().split(":")[0]),minute:parseInt(n.text().split(":")[1])});if(d<r)return d.toString("HH:mm")===$(a).prev().find("td").eq(0).text()&&m.find(".hour").remove(),$(a).prev().find("td:gt(0)").each(function(e,a){m.clone().appendTo($(a))}),!1})}}}function u(e){if(!e.data||!e.data.notes)return"-";var a=e.data.notes;return a.length>100?a.substring(0,100)+"...":a}function f(e){if(!e.data||!e.data.question1)return"-";var a=e.data.question1;return a.length>100?a.substring(0,100)+"...":a}function b(e){if(!e.data||!e.data.question2)return"-";var a=e.data.question2;return a.length>100?a.substring(0,100)+"...":a}function v(e){if(!e.data||!e.data.question3)return"-";var a=e.data.question3;return a.length>100?a.substring(0,100)+"...":a}function g(e){if(!e.data||!e.data.question4)return"-";var a=e.data.question4;return a.length>100?a.substring(0,100)+"...":a}function y(e){if(!e.data||!e.data.question5)return"-";var a=e.data.question5;return a.length>100?a.substring(0,100)+"...":a}function h(e,a){var t,r,i;$(".popover").popover("dispose");var s=$(a.target.offsetParent),d=$(a.target).parents().eq(1);$(this).hasClass("fc-unavailable")||s.hasClass("fc-unavailable")||d.hasClass("fc-unavailable")?(r=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",t=$("<div/>",{html:[$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.start.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.end.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.notes}),$("<span/>",{text:u(e)}),$("<br/>"),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2 "+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]})]})]})):$(this).hasClass("fc-working-plan-exception")||s.hasClass("fc-working-plan-exception")||d.hasClass("fc-working-plan-exception")?(r=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",t=$("<div/>",{html:[$("<strong/>",{text:EALang.provider}),$("<span/>",{text:e.data?e.data.provider.first_name+" "+e.data.provider.last_name:"-"}),$("<br/>"),$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.start.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.end.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.timezone}),$("<span/>",{text:GlobalVariables.timezones[e.data.provider.timezone]}),$("<br/>"),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2 "+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]})]})]})):(r=!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",t=$("<div/>",{html:[$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.start.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.end.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.timezone}),$("<span/>",{text:GlobalVariables.timezones[e.data.provider.timezone]}),$("<br/>"),$("<strong/>",{text:EALang.service}),$("<span/>",{text:e.data.service.name}),$("<br/>"),$("<strong/>",{text:EALang.provider}),GeneralFunctions.renderMapIcon(e.data.provider),$("<span/>",{text:e.data.provider.first_name+" "+e.data.provider.last_name}),$("<br/>"),$("<strong/>",{text:EALang.customer}),GeneralFunctions.renderMapIcon(e.data.customer),$("<span/>",{text:e.data.customer.first_name+" "+e.data.customer.last_name}),$("<br/>"),$("<strong/>",{text:EALang.email}),GeneralFunctions.renderMailIcon(e.data.customer.email),$("<span/>",{text:e.data.customer.email}),$("<br/>"),$("<strong/>",{text:EALang.phone}),GeneralFunctions.renderPhoneIcon(e.data.customer.phone_number),$("<span/>",{text:e.data.customer.phone_number}),$("<br/>"),$("<strong/>",{text:EALang.notes}),$("<span/>",{text:u(e)}),$("<br/>"),$("<strong/>",{text:"Bring own firearms?  "}),$("<span/>",{text:f(e)}),$("<br/>"),$("<strong/>",{text:"Buy ammo?  "}),$("<span/>",{text:b(e)}),$("<br/>"),$("<strong/>",{text:"Which platform?  "}),$("<span/>",{text:v(e)}),$("<br/>"),$("<strong/>",{text:"Training goals?  "}),$("<span/>",{text:g(e)}),$("<br/>"),$("<strong/>",{text:"Anything else?  "}),$("<span/>",{text:y(e)}),$("<br/>"),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2"+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]})]})]})),$(a.target).popover({placement:"top",title:e.title,content:t,html:!0,container:"#calendar",trigger:"manual"}),n=e,$(a.target).popover("toggle"),$(".popover").length>0&&$(".popover").position().top<200&&$(".popover").css("top","200px")}function _(e,a,t){if(!1===GlobalVariables.user.privileges.appointments.edit)return t(),void Backend.displayNotification(EALang.no_privileges_edit_appointments);var n,r=$("#calendar");if($("#notification").is(":visible")&&$("#notification").hide("bind"),"0"===e.data.is_unavailable){e.data.end_datetime=Date.parseExact(e.data.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:a.days(),hours:a.hours(),minutes:a.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var i=GeneralFunctions.clone(e.data);delete i.customer,delete i.provider,delete i.service,n=function(){Backend.displayNotification(EALang.appointment_updated,[{label:EALang.undo,function:function(){i.end_datetime=e.data.end_datetime=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-a.days(),hours:-a.hours(),minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_appointment",r={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(i)};$.post(n,r).done(function(){$("#notification").hide("blind")}),t()}}]),$("#footer").css("position","static"),r.fullCalendar("updateEvent",e)},BackendCalendarApi.saveAppointment(i,null,n)}else{var s={id:e.data.id,start_datetime:e.start.format("YYYY-MM-DD HH:mm:ss"),end_datetime:e.end.format("YYYY-MM-DD HH:mm:ss"),id_users_provider:e.data.id_users_provider};e.data.end_datetime=s.end_datetime,n=function(){Backend.displayNotification(EALang.unavailable_updated,[{label:EALang.undo,function:function(){s.end_datetime=e.data.end_datetime=Date.parseExact(s.end_datetime,"yyyy-MM-dd HH:mm:ss").add({minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_unavailable",r={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(s)};$.post(n,r).done(function(){$("#notification").hide("blind")}),t()}}]),$("#footer").css("position","static"),r.fullCalendar("updateEvent",e)},BackendCalendarApi.saveUnavailable(s,n)}}function E(e,a,t){if(!1===GlobalVariables.user.privileges.appointments.edit)return t(),void Backend.displayNotification(EALang.no_privileges_edit_appointments);var n;if($("#notification").is(":visible")&&$("#notification").hide("bind"),"0"===e.data.is_unavailable){var r=GeneralFunctions.clone(e.data);delete r.customer,delete r.provider,delete r.service,r.start_datetime=Date.parseExact(r.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:a.days(),hours:a.hours(),minutes:a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),r.end_datetime=Date.parseExact(r.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:a.days(),hours:a.hours(),minutes:a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=r.start_datetime,e.data.end_datetime=r.end_datetime,n=function(){Backend.displayNotification(EALang.appointment_updated,[{label:EALang.undo,function:function(){r.start_datetime=Date.parseExact(r.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-a.days(),hours:-a.hours(),minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),r.end_datetime=Date.parseExact(r.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-a.days(),hours:-a.hours(),minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=r.start_datetime,e.data.end_datetime=r.end_datetime;var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_appointment",i={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(r)};$.post(n,i).done(function(){$("#notification").hide("blind")}),t()}}]),$("#footer").css("position","static")},BackendCalendarApi.saveAppointment(r,null,n)}else{var i={id:e.data.id,start_datetime:e.start.format("YYYY-MM-DD HH:mm:ss"),end_datetime:e.end.format("YYYY-MM-DD HH:mm:ss"),id_users_provider:e.data.id_users_provider};n=function(){Backend.displayNotification(EALang.unavailable_updated,[{label:EALang.undo,function:function(){i.start_datetime=Date.parseExact(i.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-a.days(),minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),i.end_datetime=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-a.days(),minutes:-a.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=i.start_datetime,e.data.end_datetime=i.end_datetime;var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_unavailable",r={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(i)};$.post(n,r).done(function(){$("#notification").hide("blind")}),t()}}]),$("#footer").css("position","static")},BackendCalendarApi.saveUnavailable(i,n)}}function D(){var e=window.innerHeight-$("#header").outerHeight()-$("#footer").outerHeight()-$("#calendar-toolbar").outerHeight()-$(".calendar-header").outerHeight()-50;e<500&&(e=500);var a=$(".date-column"),t=$(".calendar-view > div");t.css("min-width","1000%");var n=0;a.each(function(e,a){n+=$(a).outerWidth()}),t.css("min-width",n+200);var r=a.outerHeight();$(".calendar-view .not-working").outerHeight((r>e?r:e)-70)}function x(e,a){var t=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_get_calendar_events",n={csrfToken:GlobalVariables.csrfToken,startDate:e.toString("yyyy-MM-dd"),endDate:a.toString("yyyy-MM-dd")};return $.ajax({url:t,data:n,method:"POST",beforeSend:function(){},complete:function(){}})}window.BackendCalendarTableView.initialize=function(){var e,i;!function(){$("#calendar-filter").find("select").empty().append(new Option("1 "+EALang.day,1)).append(new Option("3 "+EALang.days,3));var e,n=$("<div/>",{class:"calendar-header"}).appendTo("#calendar");switch($("<button/>",{class:"btn btn-xs btn-outline-secondary previous mr-2",html:[$("<span/>",{class:"fas fa-chevron-left"})]}).appendTo(n),$("<input/>",{type:"text",class:"form-control d-inline-block select-date mr-2",value:GeneralFunctions.formatDate(new Date,GlobalVariables.dateFormat,!1)}).appendTo(n),$("<button/>",{class:"btn btn-xs btn-outline-secondary next",html:[$("<span/>",{class:"fas fa-chevron-right"})]}).appendTo(n),GlobalVariables.dateFormat){case"DMY":e="dd/mm/yy";break;case"MDY":e="mm/dd/yy";break;case"YMD":e="yy/mm/dd";break;default:throw new Error("Invalid date format setting provided: "+GlobalVariables.dateFormat)}n.find(".select-date").datepicker({defaultDate:new Date,dateFormat:e,onSelect:function(e,a){var t=new Date(a.currentYear,a.currentMonth,a.currentDay),n=new Date(t.getTime()).add({days:parseInt($("#select-filter-item").val())-1});r(t,n)}});var i=GlobalVariables.availableProviders.filter(function(e){return GlobalVariables.user.role_slug===Backend.DB_SLUG_ADMIN||GlobalVariables.user.role_slug===Backend.DB_SLUG_SECRETARY&&-1!==GlobalVariables.secretaryProviders.indexOf(e.id)||GlobalVariables.user.role_slug===Backend.DB_SLUG_PROVIDER&&Number(e.id)===Number(GlobalVariables.user.id)});$("<label/>",{text:EALang.provider}).appendTo(n),a=$("<select/>",{id:"filter-provider",multiple:"multiple",on:{change:function(){var e=new Date($(".calendar-view .date-column:first").data("date")),a=new Date(e.getTime()).add({days:parseInt($("#select-date").val())-1});r(e,a)}}}).appendTo(n),GlobalVariables.user.role_slug!==Backend.DB_SLUG_PROVIDER?i.forEach(function(e){a.append(new Option(e.first_name+" "+e.last_name,e.id))}):i.forEach(function(e){Number(e.id)===Number(GlobalVariables.user.id)&&a.append(new Option(e.first_name+" "+e.last_name,e.id))}),a.select2();var s=GlobalVariables.availableServices.filter(function(e){var a=i.find(function(a){return-1!==a.services.indexOf(e.id)});return GlobalVariables.user.role_slug===Backend.DB_SLUG_ADMIN||a});$("<label/>",{text:EALang.service}).appendTo(n),t=$("<select/>",{id:"filter-service",multiple:"multiple",on:{change:function(){var e=new Date($(".calendar-view .date-column:first").data("date")),a=new Date(e.getTime()).add({days:parseInt($("#select-date").val())-1});r(e,a)}}}).appendTo(n),s.forEach(function(e){t.append(new Option(e.name,e.id))}),t.select2()}(),r(moment().toDate(),moment().add(Number($("#select-filter-item").val())-1,"days").toDate()),$("#insert-working-plan-exception").hide(),e=$("#calendar-toolbar"),(i=$("#calendar")).on("click",".calendar-header .btn.previous",function(){var e=$("#select-filter-item").val(),a=$(".select-date").datepicker("getDate"),t=moment(a).subtract(1,"days"),n=t.clone().add(e-1,"days");$(".select-date").datepicker("setDate",t.toDate()),r(t.toDate(),n.toDate())}),i.on("click",".calendar-header .btn.next",function(){var e=$("#select-filter-item").val(),a=$(".select-date").datepicker("getDate"),t=moment(a).add(1,"days"),n=t.clone().add(e-1,"days");$(".select-date").datepicker("setDate",t.toDate()),r(t.toDate(),n.toDate())}),e.on("change","#select-filter-item",function(){var e=$("#select-filter-item").val(),a=$(".select-date").datepicker("getDate"),t=moment(a),n=t.clone().add(e-1,"days");r(t.toDate(),n.toDate())}),e.on("click","#reload-appointments",function(){$(".calendar-view .event").remove();var e=$("#select-filter-item").val(),a=$(".select-date").datepicker("getDate"),t=moment(a),n=t.toDate(),r=t.clone().add(e-1,"days").toDate();x(n,r).done(function(e){for(var a=n;a<=r;)$(".calendar-view .date-column").each(function(t,n){var r=$(n),i=new Date(r.data("date"));if(a.getTime()!==i.getTime())return!0;r.find(".date-column-title").text(GeneralFunctions.formatDate(i,GlobalVariables.dateFormat)),r.find(".provider-column").each(function(a,t){var n=$(t),r=n.data("provider");n.find(".calendar-wrapper").fullCalendar("removeEvents"),l(n.find(".calendar-wrapper"),n.data("provider")),c(n,e.appointments),m(n,e.unavailability_events);var s=JSON.parse(r.settings.working_plan),d=i.toString("dddd").toLowerCase();s[d]&&p(n,s[d].breaks)})}),a.add({days:1});Backend.placeFooterToBottom()})}),$(window).on("resize",function(){D()}),i.on("click",".close-popover",function(){$(this).parents(".popover").popover("dispose")}),i.on("click",".edit-popover",function(){var e;if($(this).parents(".popover").popover("dispose"),n.data.workingPlanException){var a=n.data.date,t=n.data.workingPlanException,r=n.data.provider;WorkingPlanExceptionsModal.edit(a,t).done(function(e,a){BackendCalendarApi.saveWorkingPlanException(e,a,r.id,function(){Backend.displayNotification(EALang.working_plan_exception_saved);var t=jQuery.parseJSON(r.settings.working_plan_exceptions)||{};for(var n in t[e]=a,GlobalVariables.availableProviders){var i=GlobalVariables.availableProviders[n];if(Number(i.id)===Number(r.id)){i.settings.working_plan_exceptions=JSON.stringify(t);break}}$("#select-filter-item").trigger("change")},null)})}else if("0"===n.data.is_unavailable){var i=n.data;e=$("#manage-appointment"),BackendCalendarAppointmentsModal.resetAppointmentDialog(),e.find(".modal-header h3").text(EALang.edit_appointment_title),e.find("#appointment-id").val(i.id),e.find("#select-service").val(i.id_services).trigger("change"),e.find("#select-provider").val(i.id_users_provider);var s=Date.parseExact(i.start_datetime,"yyyy-MM-dd HH:mm:ss");e.find("#start-datetime").datetimepicker("setDate",s);var d=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss");e.find("#end-datetime").datetimepicker("setDate",d);var o=i.customer;e.find("#customer-id").val(i.id_users_customer),e.find("#first-name").val(o.first_name),e.find("#last-name").val(o.last_name),e.find("#email").val(o.email),e.find("#phone-number").val(o.phone_number),e.find("#address").val(o.address),e.find("#city").val(o.city),e.find("#zip-code").val(o.zip_code),e.find("#appointment-location").val(i.location),e.find("#appointment-notes").val(i.notes),e.find("#appointment-question1").val(i.question1),e.find("#appointment-question2").val(i.question2),e.find("#appointment-question3").val(i.question3),e.find("#appointment-question4").val(i.question4),e.find("#appointment-question5").val(i.question5),e.find("#customer-notes").val(o.notes),e.modal("show")}else{var l=n.data;l.start_datetime=n.start.format("YYYY-MM-DD HH:mm:ss"),s=Date.parseExact(l.start_datetime,"yyyy-MM-dd HH:mm:ss"),l.end_datetime=n.end.format("YYYY-MM-DD HH:mm:ss"),d=Date.parseExact(l.end_datetime,"yyyy-MM-dd HH:mm:ss"),e=$("#manage-unavailable"),BackendCalendarUnavailabilityEventsModal.resetUnavailableDialog(),e.find(".modal-header h3").text("Edit Unavailable Period"),e.find("#unavailable-start").datetimepicker("setDate",s),e.find("#unavailable-id").val(l.id),e.find("#unavailable-provider").val(l.id_users_provider),e.find("#unavailable-end").datetimepicker("setDate",d),e.find("#unavailable-notes").val(l.notes),e.modal("show")}}),i.on("click",".delete-popover",function(){var e,a;if($(this).parents(".popover").popover("dispose"),n.data.hasOwnProperty("id_roles"))e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_working_plan_exception",a={csrfToken:GlobalVariables.csrfToken,working_plan_exception:n.start.format("YYYY-MM-DD"),provider_id:n.data.id},$.post(e,a).done(function(){$("#message-box").dialog("close");var e=jQuery.parseJSON(n.data.settings.working_plan_exceptions);delete e[n.start.format("YYYY-MM-DD")],n.data.settings.working_plan_exceptions=JSON.stringify(e),$("#select-filter-item").trigger("change")});else if("0"===n.data.is_unavailable){var t=[{text:EALang.cancel,click:function(){$("#message-box").dialog("close")}},{text:"OK",click:function(){e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_appointment",a={csrfToken:GlobalVariables.csrfToken,appointment_id:n.data.id,delete_reason:$("#delete-reason").val()},$.post(e,a).done(function(){$("#message-box").dialog("close"),$("#select-filter-item").trigger("change")})}}];GeneralFunctions.displayMessageBox(EALang.delete_appointment_title,EALang.write_appointment_removal_reason,t),$("<textarea/>",{class:"form-control w-100",id:"delete-reason",rows:"3"}).appendTo("#message-box")}else e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_unavailable",a={csrfToken:GlobalVariables.csrfToken,unavailable_id:n.data.id},$.post(e,a).done(function(){$("#message-box").dialog("close"),$("#select-filter-item").trigger("change")})}),$("#enable-sync, #google-sync").hide()}}();